<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Messenger Translator üåç</title>
<style>
body { font-family: Arial; background: #f0f2f5; padding: 20px; }
h1 { color: #2c3e50; text-align: center; }
.controls { display: flex; justify-content: center; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
.controls div { display: flex; align-items: center; gap: 5px; }
select, button { padding: 8px 12px; font-size: 14px; }
#indicator1, #indicator2 { width: 12px; height: 12px; border-radius: 50%; background: red; }
#chat { max-width: 600px; margin: auto; background: #fff; padding: 15px; border-radius: 15px; height: 400px; overflow-y: auto; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }
.message { max-width: 70%; padding: 8px 12px; margin: 5px; border-radius: 12px; position: relative; word-wrap: break-word; }
.user1 { background: #dfefff; align-self: flex-start; border-top-left-radius: 0; }
.user2 { background: #fff0df; align-self: flex-end; border-top-right-radius: 0; }
.copy-btn { font-size: 10px; padding: 2px 5px; margin-left: 5px; }
.chat-wrapper { display: flex; flex-direction: column; }
.note { font-size: 12px; color: #888; text-align: center; margin-top: 5px; }
</style>
</head>
<body>
<h1>Messenger Translator üåç</h1>

<div class="controls">
  <div>
    <label>User 1:</label>
    <select id="lang1">
      <option value="ru-RU">–†—É—Å—Å–∫–∏–π</option>
      <option value="en-US">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
      <option value="es-ES">–ò—Å–ø–∞–Ω—Å–∫–∏–π*</option>
      <option value="fr-FR">–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π*</option>
    </select>
    <button id="start1">Start</button>
    <button id="stop1">Stop</button>
    <div id="indicator1"></div>
  </div>
  <div>
    <label>User 2:</label>
    <select id="lang2">
      <option value="en">–ê–Ω–≥–ª–∏–π—Å–∫–∏–π</option>
      <option value="ru">–†—É—Å—Å–∫–∏–π</option>
      <option value="es">–ò—Å–ø–∞–Ω—Å–∫–∏–π</option>
      <option value="fr">–§—Ä–∞–Ω—Ü—É–∑—Å–∫–∏–π</option>
    </select>
    <button id="start2">Start</button>
    <button id="stop2">Stop</button>
    <div id="indicator2"></div>
  </div>
</div>
<p class="note">*–ü—Ä–æ–≤–µ—Ä—è–π—Ç–µ –ø–æ–¥–¥–µ—Ä–∂–∫—É –≤ Chrome</p>

<div id="chat" class="chat-wrapper"></div>

<script>
if (!('webkitSpeechRecognition' in window) && !('SpeechRecognition' in window)) {
  alert("–í–∞—à –±—Ä–∞—É–∑–µ—Ä –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç SpeechRecognition. –ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ Chrome –∏–ª–∏ Edge.");
}

// –°–æ–∑–¥–∞–µ–º —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è –¥–ª—è –∫–∞–∂–¥–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
const recognition1 = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition1.continuous = true;
recognition1.interimResults = false;

const recognition2 = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
recognition2.continuous = true;
recognition2.interimResults = false;

const chatDiv = document.getElementById('chat');
const lang1Select = document.getElementById('lang1');
const lang2Select = document.getElementById('lang2');
const indicator1 = document.getElementById('indicator1');
const indicator2 = document.getElementById('indicator2');

let activeLang1 = lang1Select.value;
lang1Select.onchange = () => activeLang1 = lang1Select.value;

// –ü–µ—Ä–µ–≤–æ–¥ —á–µ—Ä–µ–∑ MyMemory API
async function translateText(text, source, target){
  const url = `https://api.mymemory.translated.net/get?q=${encodeURIComponent(text)}&langpair=${source}|${target}`;
  const response = await fetch(url);
  const data = await response.json();
  return data.responseData.translatedText;
}

// –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Å–æ–æ–±—â–µ–Ω–∏–π –≤ —á–∞—Ç
function addMessage(userClass, text, translation, targetLang){
  const msg = document.createElement('div');
  msg.classList.add('message', userClass);
  msg.textContent = text;
  chatDiv.appendChild(msg);

  const msgTr = document.createElement('div');
  msgTr.classList.add('message', userClass === 'user1' ? 'user2' : 'user1');
  msgTr.innerHTML = `${translation} (${targetLang}) <button class="copy-btn" onclick="navigator.clipboard.writeText('${translation}')">–ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>`;
  chatDiv.appendChild(msgTr);

  chatDiv.scrollTop = chatDiv.scrollHeight; // –ø–ª–∞–≤–Ω–∞—è –ø—Ä–æ–∫—Ä—É—Ç–∫–∞ –≤–Ω–∏–∑

  const utter = new SpeechSynthesisUtterance(translation);
  utter.lang = targetLang + '-' + targetLang.toUpperCase();
  speechSynthesis.speak(utter);
}

// –°—Ç–∞—Ä—Ç/—Å—Ç–æ–ø User 1
document.getElementById('start1').onclick = () => { recognition1.lang = activeLang1; recognition1.start(); indicator1.style.background='green'; };
document.getElementById('stop1').onclick = () => { recognition1.stop(); indicator1.style.background='red'; };

// –°—Ç–∞—Ä—Ç/—Å—Ç–æ–ø User 2
document.getElementById('start2').onclick = () => { recognition2.lang = lang2Select.value + '-' + lang2Select.value.toUpperCase(); recognition2.start(); indicator2.style.background='green'; };
document.getElementById('stop2').onclick = () => { recognition2.stop(); indicator2.style.background='red'; };

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—á–∏ User 1 —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º —è–∑—ã–∫–æ–º
recognition1.onresult = async (event) => {
  let text = event.results[event.results.length-1][0].transcript.trim();
  let sourceLang = activeLang1.split('-')[0];
  let targetLang = lang2Select.value;

  if(!text || text.length < 2){
    recognition1.stop();
    recognition1.lang = lang2Select.value + '-' + lang2Select.value.toUpperCase(); // —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —è–∑—ã–∫
    recognition1.start();
    return;
  }

  const translation = await translateText(text, sourceLang, targetLang);
  addMessage('user1', text + ` (${sourceLang})`, translation, targetLang);

  recognition1.stop();
  recognition1.lang = activeLang1;
  recognition1.start();
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–µ—á–∏ User 2 —Å —Ä–µ–∑–µ—Ä–≤–Ω—ã–º —è–∑—ã–∫–æ–º
recognition2.onresult = async (event) => {
  let text = event.results[event.results.length-1][0].transcript.trim();
  let sourceLang = lang2Select.value;
  let targetLang = activeLang1.split('-')[0];

  if(!text || text.length < 2){
    recognition2.stop();
    recognition2.lang = activeLang1; // —Ä–µ–∑–µ—Ä–≤–Ω—ã–π —è–∑—ã–∫
    recognition2.start();
    return;
  }

  const translation = await translateText(text, sourceLang, targetLang);
  addMessage('user2', text + ` (${sourceLang})`, translation, targetLang);

  recognition2.stop();
  recognition2.lang = lang2Select.value + '-' + lang2Select.value.toUpperCase();
  recognition2.start();
};
</script>
</body>
</html>
