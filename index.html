<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Стратегическая аркада: армия</title>
<style>
  body {
    margin: 0;
    background: #222;
    color: white;
    font-family: sans-serif;
    text-align: center;
  }
  #gameCanvas {
    display: block;
    margin: 0 auto;
    background: #333;
    border: 2px solid #fff;
  }
  p { margin: 5px; }
</style>
</head>
<body>

<h1>Командуй своей армией!</h1>
<canvas id="gameCanvas" width="700" height="400"></canvas>
<p>Армия: <span id="armySize">4</span> | Счет: <span id="score">0</span></p>
<p>Выделите юнитов кликом мыши, затем кликните на врага для атаки или на поле для следования</p>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let player = { x: 50, y: 200, size: 20, color: 'cyan', speed: 4 };
let army = [
  { x: 30, y: 180, size: 15, color: 'blue', type: 'infantry', selected: false, target: null },
  { x: 30, y: 220, size: 15, color: 'blue', type: 'archer', selected: false, target: null },
  { x: 30, y: 200, size: 15, color: 'blue', type: 'infantry', selected: false, target: null }
];
let enemies = [];
let score = 0;

// Управление игроком
let keys = {};
document.addEventListener('keydown', e => keys[e.key] = true);
document.addEventListener('keyup', e => keys[e.key] = false);

// Клик мыши для выделения и приказов
canvas.addEventListener('click', e => {
  const rect = canvas.getBoundingClientRect();
  const mouseX = e.clientX - rect.left;
  const mouseY = e.clientY - rect.top;

  // Сначала проверяем, кликнули ли на юнитов для выделения
  let clickedUnit = false;
  army.forEach(unit => {
    if(mouseX >= unit.x && mouseX <= unit.x + unit.size &&
       mouseY >= unit.y && mouseY <= unit.y + unit.size) {
      unit.selected = !unit.selected;
      clickedUnit = true;
    }
  });

  if(!clickedUnit) {
    // Если клик не на юните, отдаём приказ выделенным юнитам
    army.forEach(unit => {
      if(unit.selected) {
        // Проверяем, клик на враге
        let enemyClicked = enemies.find(e => mouseX >= e.x && mouseX <= e.x + e.size &&
                                            mouseY >= e.y && mouseY <= e.y + e.size);
        unit.target = enemyClicked || { x: mouseX, y: mouseY };
      }
    });
  }
});

// Создание врагов
function spawnEnemy() {
  enemies.push({
    x: canvas.width,
    y: Math.random() * (canvas.height - 20),
    size: 20,
    color: 'red',
    speed: 1 + Math.random() * 1.5,
    health: 2
  });
}

// Проверка столкновения
function isColliding(a, b) {
  return a.x < b.x + b.size &&
         a.x + a.size > b.x &&
         a.y < b.y + b.size &&
         a.y + a.size > b.y;
}

// Обновление игры
function update() {
  // Движение игрока
  if(keys['ArrowUp']) player.y -= player.speed;
  if(keys['ArrowDown']) player.y += player.speed;
  if(keys['ArrowLeft']) player.x -= player.speed;
  if(keys['ArrowRight']) player.x += player.speed;

  player.x = Math.max(0, Math.min(canvas.width - player.size, player.x));
  player.y = Math.max(0, Math.min(canvas.height - player.size, player.y));

  // Движение армии
  army.forEach(unit => {
    if(unit.target) {
      let dx = unit.target.x - unit.x;
      let dy = unit.target.y - unit.y;
      let dist = Math.sqrt(dx*dx + dy*dy);
      if(dist > 1) {
        unit.x += dx / dist * 2;
        unit.y += dy / dist * 2;
      } else {
        // Если юнит достиг цели и это враг
        if(enemies.includes(unit.target)) {
          unit.target.health -= 1;
          if(unit.target.health <= 0) {
            score++;
            document.getElementById('score').textContent = score;
            enemies.splice(enemies.indexOf(unit.target), 1);
          }
        }
        unit.target = null;
      }
    } else {
      // Следовать за игроком если нет приказа
      let dx = player.x - unit.x - 20;
      let dy = player.y - unit.y;
      unit.x += dx * 0.05;
      unit.y += dy * 0.05;
    }
  });

  // Враги двигаются к игроку
  if(Math.random() < 0.01) spawnEnemy();
  enemies.forEach(enemy => {
    let dx = player.x - enemy.x;
    let dy = player.y - enemy.y;
    let dist = Math.sqrt(dx*dx + dy*dy);
    enemy.x += dx / dist * enemy.speed;
    enemy.y += dy / dist * enemy.speed;

    if(isColliding(player, enemy)) {
      alert(`Игра окончена! Ваш счет: ${score}`);
      window.location.reload();
    }

    // Взаимодействие с армией
    army.forEach(unit => {
      if(isColliding(unit, enemy)) {
        enemy.health -= 1;
        if(enemy.health <= 0) {
          score++;
          document.getElementById('score').textContent = score;
          enemies.splice(enemies.indexOf(enemy), 1);
        }
      }
    });
  });
}

// Отрисовка
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // Игрок
  ctx.fillStyle = player.color;
  ctx.fillRect(player.x, player.y, player.size, player.size);

  // Армия
  army.forEach(unit => {
    ctx.fillStyle = unit.selected ? 'green' : unit.color;
    ctx.fillRect(unit.x, unit.y, unit.size, unit.size);
  });

  // Враги
  enemies.forEach(enemy => {
    ctx.fillStyle = enemy.color;
    ctx.fillRect(enemy.x, enemy.y, enemy.size, enemy.size);
  });
}

// Игровой цикл
function gameLoop() {
  update();
  draw();
  requestAnimationFrame(gameLoop);
}

gameLoop();
</script>

</body>
</html>
