<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Хардкор Tower Defense</title>
<style>
  body { margin:0; background:#111; color:white; font-family:sans-serif; text-align:center; }
  canvas { display:block; margin:0 auto; background:#222; border:2px solid #fff; }
  button { margin:5px; padding:5px 10px; }
</style>
</head>
<body>

<h1>Хардкор Tower Defense</h1>
<p>Золото: <span id="gold">150</span> | Жизни: <span id="lives">15</span> | Волна: <span id="wave">1</span></p>
<button onclick="setTowerType('archer')">Лучник (50)</button>
<button onclick="setTowerType('mage')">Маг (80)</button>
<button onclick="setTowerType('catapult')">Катапульта (100)</button>
<button onclick="setTowerType('slow')">Замедляющая (60)</button>
<button onclick="upgradeTower()">Улучшить выбранную (100)</button>
<canvas id="gameCanvas" width="900" height="500"></canvas>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let gold = 150;
let lives = 15;
let wave = 1;
let towerType = 'archer';
let selectedTower = null;

// Множество маршрутов
const paths = [
  [{x:0,y:100},{x:900,y:100}],
  [{x:0,y:200},{x:900,y:200}],
  [{x:0,y:300},{x:900,y:300}],
  [{x:0,y:400},{x:900,y:400}]
];

let enemies = [];
let towers = [];
let projectiles = [];

// Тип башни
function setTowerType(type){ towerType=type; }

// Установка или выбор башни
canvas.addEventListener('click', e=>{
  const rect = canvas.getBoundingClientRect();
  const x = e.clientX - rect.left;
  const y = e.clientY - rect.top;

  selectedTower = towers.find(t=>Math.abs(t.x-x)<t.size && Math.abs(t.y-y)<t.size);
  if(selectedTower) return;

  if(towerType==='archer' && gold>=50){ towers.push({x,y,size:20,type:'archer',range:100,damage:5,cooldown:0,level:1}); gold-=50; }
  if(towerType==='mage' && gold>=80){ towers.push({x,y,size:20,type:'mage',range:120,damage:8,cooldown:0,level:1}); gold-=80; }
  if(towerType==='catapult' && gold>=100){ towers.push({x,y,size:20,type:'catapult',range:150,damage:12,cooldown:0,level:1}); gold-=100; }
  if(towerType==='slow' && gold>=60){ towers.push({x,y,size:20,type:'slow',range:80,damage:0,cooldown:0,level:1}); gold-=60; }

  document.getElementById('gold').textContent = gold;
});

// Улучшение башни
function upgradeTower(){
  if(selectedTower && gold>=100){
    selectedTower.level++;
    selectedTower.damage += selectedTower.type==='archer'?3:selectedTower.type==='mage'?5:selectedTower.type==='catapult'?8:0;
    selectedTower.range += 10;
    gold -=100;
    document.getElementById('gold').textContent = gold;
  }
}

// Спавн врагов с разными типами
function spawnEnemy(){
  const path = paths[Math.floor(Math.random()*paths.length)];
  let typeRoll = Math.random();
  let type='normal', hp=15+wave*5, speed=1+wave*0.2;
  if(typeRoll<0.15){ type='fast'; hp=10+wave*4; speed=2+wave*0.3; }
  else if(typeRoll<0.25){ type='tank'; hp=40+wave*10; speed=0.5+wave*0.1; }
  else if(typeRoll<0.35){ type='healer'; hp=20+wave*5; speed=1+wave*0.2; }
  else if(typeRoll<0.45){ type='flying'; hp=15+wave*5; speed=1.5+wave*0.2; }
  else if(typeRoll<0.5){ type='invisible'; hp=25+wave*6; speed=1+wave*0.3; }

  enemies.push({x:path[0].x, y:path[0].y, size:20, hp, speed, type, path});
}

// Движение врагов и атака
function update(){
  enemies.forEach((enemy,i)=>{
    let target = enemy.path[1];
    let dx=target.x-enemy.x, dy=target.y-enemy.y, dist=Math.sqrt(dx*dx+dy*dy);
    enemy.x+=dx/dist*enemy.speed;
    enemy.y+=dy/dist*enemy.speed;

    // Бонусы и случайные ускорения
    if(Math.random()<0.001) enemy.speed *= 1.5;

    if(dist<5){ enemies.splice(i,1); lives--; document.getElementById('lives').textContent=lives;
      if(lives<=0){ alert("Вы проиграли!"); window.location.reload(); }
    }
  });

  towers.forEach(t=>{
    if(t.cooldown>0) t.cooldown--;
    enemies.forEach(enemy=>{
      if(enemy.type==='invisible' && t.type!=='mage') return; // невидимые враги только для магов
      let dx=enemy.x-t.x, dy=enemy.y-t.y, dist=Math.sqrt(dx*dx+dy*dy);
      if(dist<t.range && t.cooldown===0){
        if(t.type==='slow') enemy.speed*=0.5;
        else projectiles.push({x:t.x,y:t.y,target:enemy,damage:t.damage,type:t.type});
        t.cooldown = t.type==='archer'?30:t.type==='mage'?50:t.type==='catapult'?80:50;
      }
    });
  });

  projectiles.forEach((p,i)=>{
    if(!p.target){ projectiles.splice(i,1); return; }
    let dx=p.target.x-p.x, dy=p.target.y-p.y, dist=Math.sqrt(dx*dx+dy*dy);
    if(dist<5){
      p.target.hp-=p.damage;
      projectiles.splice(i,1);
      if(p.target.hp<=0){ gold+=10; document.getElementById('gold').textContent=gold; enemies.splice(enemies.indexOf(p.target),1);}
    } else { p.x+=dx/dist*5; p.y+=dy/dist*5; }
  });

  if(Math.random()<0.03*wave) spawnEnemy(); // больше врагов на высоких волнах
}

// Отрисовка
function draw(){
  ctx.clearRect(0,0,canvas.width,canvas.height);

  paths.forEach(path=>{ ctx.strokeStyle='gray'; ctx.lineWidth=20; ctx.beginPath(); ctx.moveTo(path[0].x,path[0].y); ctx.lineTo(path[1].x,path[1].y); ctx.stroke(); });

  enemies.forEach(e=>{ 
    ctx.fillStyle=e.type==='fast'?'orange':e.type==='tank'?'darkred':e.type==='healer'?'green':e.type==='flying'?'white':'purple';
    ctx.fillRect(e.x-e.size/2,e.y-e.size/2,e.size,e.size);
  });

  towers.forEach(t=>{ 
    ctx.fillStyle=t.type==='archer'?'blue':t.type==='mage'?'purple':t.type==='catapult'?'brown':'cyan';
    ctx.fillRect(t.x-t.size/2,t.y-t.size/2,t.size,t.size);
    ctx.strokeStyle='rgba(0,255,255,0.3)'; ctx.beginPath(); ctx.arc(t.x,t.y,t.range,0,Math.PI*2); ctx.stroke();
  });

  projectiles.forEach(p=>{ ctx.fillStyle=p.type==='archer'?'yellow':p.type==='mage'?'orange':p.type==='catapult'?'red':'white';
    ctx.beginPath(); ctx.arc(p.x,p.y,5,0,Math.PI*2); ctx.fill();
  });
}

// Игровой цикл
function gameLoop(){ update(); draw(); requestAnimationFrame(gameLoop); }

gameLoop();
</script>
</body>
</html>
